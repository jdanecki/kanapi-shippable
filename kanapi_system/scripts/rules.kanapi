DIR_NAME=$@-$($(@)_ver)
check_dir=if [ ! -d  $(DIR_NAME) ]; then mkdir $(DIR_NAME) ; ln -svf ../../packages/$(DIR_NAME)/$@.kanapi $(DIR_NAME); fi
DATE_RULE=/bin/date > $@

ifeq ($(ACTION),)
RUN_TARGET=make kanapi_help
else
RUN_TARGET=$(call check_dir); make -f ../Makefile -C $@-$($@_ver) kanapi_$(ACTION) PKG=$@ KANAPI_TOP=$(PWD) V=$(V)
endif

kanapi_download:
	@if [ "$${TRAVIS}" = "true" ] ; then echo "travis_fold:start:$(PKG)_download" ; fi
	pkg_kanapi $(PKG).kanapi download $(V)
	@if [ "$${TRAVIS}" = "true" ] ; then echo "travis_fold:end:$(PKG)_download" ; fi
	$(call DATE_RULE)

kanapi_redownload:
	pkg_kanapi $(PKG).kanapi redownload $(V)

kanapi_prepare: kanapi_download
	@if [ "$${TRAVIS}" = "true" ] ; then echo "travis_fold:start:$(PKG)_prepare" ; fi
	pkg_kanapi $(PKG).kanapi prepare $(V)
	@if [ "$${TRAVIS}" = "true" ] ; then echo "travis_fold:end:$(PKG)_prepare" ; fi
	$(call DATE_RULE)

kanapi_configure: kanapi_prepare
	@if [ "$${TRAVIS}" = "true" ] ; then echo "travis_fold:start:$(PKG)_configure" ; fi
	pkg_kanapi $(PKG).kanapi configure $(V); if [ "$$?" != "0" ] ; then find . -name config.log -exec cat {} \; ; false; fi
	@if [ "$${TRAVIS}" = "true" ] ; then echo "travis_fold:end:$(PKG)_configure" ; fi
	$(call DATE_RULE)

kanapi_reconfigure:
	pkg_kanapi $(PKG).kanapi configure $(V)

kanapi_build: kanapi_configure
	@if [ "$${TRAVIS}" = "true" ] ; then echo "travis_fold:start:$(PKG)_build" ; fi
	pkg_kanapi $(PKG).kanapi build $(V)
	@if [ "$${TRAVIS}" = "true" ] ; then echo "travis_fold:end:$(PKG)_build" ; fi
	$(call DATE_RULE)

kanapi_rebuild:
	pkg_kanapi $(PKG).kanapi build $(V)

kanapi_install: kanapi_build
	@if [ "$${TRAVIS}" = "true" ] ; then echo "travis_fold:start:$(PKG)_install" ; fi
	pkg_kanapi $(PKG).kanapi install $(V) ; if [ "$$?" = "0" ] ; then pkg_kanapi $(PKG).kanapi verify $(V) ; else false; fi
	@if [ "$${TRAVIS}" = "true" ] ; then echo "travis_fold:end:$(PKG)_install" ; fi
	$(call DATE_RULE)

kanapi_reinstall:
	pkg_kanapi $(PKG).kanapi install $(V) ; if [ "$$?" = "0" ] ; then pkg_kanapi $(PKG).kanapi verify $(V) ; else false; fi
	/bin/date > kanapi_install

kanapi_uninstall:
	pkg_kanapi $(PKG).kanapi uninstall $(V)

kanapi_clean:
	pkg_kanapi $(PKG).kanapi clean $(V)

kanapi_test:
	pkg_kanapi $(PKG).kanapi test $(V)

kanapi_check:
	pkg_kanapi $(PKG).kanapi check $(V)

kanapi_verify:
	pkg_kanapi $(PKG).kanapi verify $(V)
	$(call DATE_RULE)

kanapi_version:
	pkg_kanapi $(PKG).kanapi version $(V)

kanapi_help:
	@echo "**********   Help  **********"
	@echo "run: make package ACTION=action"
	@echo "where action is one from:"
	@echo "download    - download sources"
	@echo "prepare     - uncompress sources"
	@echo "configure   - configure package/packages"
	@echo "build       - build package/packages"
	@echo "install     - install package/packages"
	@echo "reconfigure - reconfigure package/packages"
	@echo "rebuild     - rebuild package/packages"
	@echo "reinstall   - reinstall package/packages"

